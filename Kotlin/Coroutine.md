# Coroutine

처음 코루틴이라는 개념을 접했을 때 굉장히 복잡했던 기억이 난다. 물론 지금도 코루틴이라는 개념이 절대 만만하지도 않고 여전히 어려운건 매한가지이지만,
알고보니 처음 접했던 개념보다는 훨씬 명료하여 정리해보고자 한다.

나 같은 경우 코루틴이라는 것을 코틀린을 배우기 전부터 알고 있었는데, 그냥 비동기적 프로그래밍을 지원하는 것 정도로만 알고 있었다.
서브루틴이니, 어떤 루틴이니 개념이 낯설어 그런게 있나 보다~ 라는 정도..

그리고 현 회사에 입사하여 코루틴을 사용할 일이 생겨, `Kotlin In Action` 의 코루틴 챕터를 보고선 굉장히 당황했던 기억이 난다.. 
Kotlin In Action 에서는 코루틴을 다음과 같이 정의한다 :
> 코루틴은 컴퓨터 프로그램 구성 요소 중 하나로 비선점형 멀티태스킹을 수행하는 일반화한 서브루틴이다.
> 코루틴은 실행을 일시 중단하고 재개할 수 있는 여러 진입 지점을 허용한다.

여전히 코린이지만 찐 코린이었던 당시에 이 문장을 보고 굉장히 당황했던 기억이 난다.. 비선점..? 그걸 일반화..? 

개인적으로 코루틴에 대한 설명은 코틀린 공식 사이트가 훨씬 친절하고 쉽게 되어있어, 입문자라면 [공식 reference](https://kotlinlang.org/docs/coroutines-guide.html)
를 참고하는 것을 추천한다. 코루틴과 동시성 프로그래밍의 전반적인 이해는 [이 블로그](https://wooooooak.github.io/kotlin/2019/08/25/%EC%BD%94%ED%8B%80%EB%A6%B0-%EC%BD%94%EB%A3%A8%ED%8B%B4-%EA%B0%9C%EB%85%90-%EC%9D%B5%ED%9E%88%EA%B8%B0/)
에 정리가 잘 되어있다.

코루틴을 이런 식으로 이해해본다면 조금 쉬울 것 같다. (내 기준..)

깜빡하고 보조배터리를 가지고 나오지 않은 나는 친구가 보조배터리를 통해 친구의 휴대폰을 충전하고 있는 것을 보고, 잠시동안 빌려달라고 부탁을 한다.

이를 코드로 표현해보면
``` kotlin 
batteryCharger.charge(friendPhone);
batteryCharger.charge(myPhone);
//...
``` 
위가 일반적인 코드이지만, 문제점이 있다. 위 코드는 동기적이기 때문에, 친구의 핸드폰이 모두 충전이 되어야 보조 배터리를 사용할 수 있다는 점이다.

위에 정의된 코틀린의 특상인, `실행을 일시 중단` 할 수 있다는 점은 바로 이러한 문제를 해결해준다. 친구의 충전을 잠시 멈추고 내 휴대폰을 충전할 수 있는 진입점을 만들 수 있다.

``` kotlin

fun main(args: Array<String>) = runBlocking {
    launch {
        chargePhone(myPhone)
    }
    friendPhone.charge()
}

suspend fun chargePhone(phone: WhosePhone) {
    phone.charge()
} 
```

`서브루틴` 은 쉽게 말해 함수이다. 
> 코루틴은 컴퓨터 프로그램 구성 요소 중 하나로 비선점형 멀티태스킹을 수행하는 일반화한 서브루틴이다.

이 말은 즉슨 다양한 함수들이 동시적으로 함수 내부의 일을 수행한다는 뜻이다. 그런데 이러한 멀티 태스킹이 실행되는 방식이 조금 흥미롭다. 
동시에 무언가를 수행하는 방법엔 다양한 것들이 있을 것이다. 

비선점형이라는 뜻은, 하나의 스레드를 서브루틴들이 독점하는 것이 아닌 필요에 따라 스레드를 사용한 뒤 반납한다는 개념으로 이해하면 쉬울 것 같다.

여러 개의 스레드를 통해 다양한 일을 병렬로 수행하는 방법도 있겠지만, 코루틴에서는 suspend 함수를 통해 중지 지점을 설정함으로써, 하나의 서브 루틴(함수)의 일이 끝나면 그 스레드를 다른 서브루틴에게 넘겨준다.

> 코루틴을 일시 중단하면 사용중인 스레드를 block 하는 것이 아니라, 다른 코루틴으로 하여금 본인들의 코드에 사용중이었던
스레드를 사용하도록 하는 것이다.

